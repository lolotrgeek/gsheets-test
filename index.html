<!DOCTYPE html>
<html>

<head>
  <title>Google Sheets API Blog</title>
  <meta charset="utf-8" />
</head>

<body>
  <p>Google Sheets API Blog</p>

  <pre id="content" style="white-space: pre-wrap;"></pre>

  <!-- https://developers.google.com/sheets/api/samples/reading -->
  <script type="text/javascript">
    // sheet
    let sheet = 'CMS!'
    // column letters
    let titles = 'A'
    let urls = 'B'
    let tags = 'C'
    let dates = 'D'
    let contents = 'E'
    // rows 
    let firstContentRow = 3
    // parsers
    let getAll = (column, row) => sheet + column + row + ':' + column
    let get = (column, row) => sheet + column + row

    const queries = {
      titles: getAll(titles, firstContentRow),
      links: getAll(urls, firstContentRow),
      tags: getAll(tags, firstContentRow),
      dates: getAll(dates, firstContentRow),
      contents: getAll(contents, firstContentRow),
      posts: [getAll(titles, firstContentRow), getAll(urls, firstContentRow), getAll(tags, firstContentRow), getAll(dates, firstContentRow)],
    }
    const apikey = 'AIzaSyDLgbHuIKYEhhDoVz9pdwkU4LgqNGMQT3A'
    const sheetid = '17mMZ4fb-IpTDbqoTxdjF_EeRpnoJuef58yMHIQI9Ri4'
    const base = 'https://sheets.googleapis.com/v4/spreadsheets/'

    let content = document.getElementById('content')

    const buildQuery = (query) => new Promise((resolve, reject) => {
      if (!query) {
        reject('404')
      }
      else if (Array.isArray(query)) {
        //parse a batch query
        let ranges = ''
        query.map((range, index) => (index === 0) ? ranges += 'ranges=' + range : ranges += '&ranges=' + range)
        resolve(base + sheetid + '/values:batchGet?' + ranges + '&key=' + apikey)
      }
      else {
        // parse a single query
        resolve(base + sheetid + '/values/' + query + '?key=' + apikey)
      }
    })


    const getQuery = async (url) => new Promise((resolve, reject) => {
      fetch(url)
        .then(response => response.json())
        .then(query => resolve(query))
        .catch(err => reject(err))
    })

    const parseQuery = async (query) => new Promise((resolve, reject) => {
      let result = {}
      if (typeof query !== 'object') {
        console.log('query not object')
        reject('404')
      }
      else if (query.valueRanges) {
        if (query.valueRanges.length !== 4) {
          console.log('query to short')
          reject('404')
        } else {
          result.titles = query.valueRanges[0].values
          result.links = query.valueRanges[1].values
          result.tags = query.valueRanges[2].values
          result.dates = query.valueRanges[3].values
          resolve(result)
        }
      }
      else if (query.values) {
        result.post = query.values
        resolve(result)
      }
    })

    const buildHome = (result) => new Promise((resolve, reject) => {
      let blog =  `<ul class="posts">
      ${result.titles.map((title, index) => `<li class="post-title"><a href="/${result.links[index]} ">${title}</a></li>`).join('')}
      </ul>`
      resolve(blog)
    })

    const buildRoutes = async (result) => new Promise((resolve, reject) => {
      let routes = {}
      buildHome(result)
        .then(home => {
          routes['/'] = home
          routes['/index.html'] = home
        })
        .then(() => result.links.map((link, index) => routes['/' + link] = index + 3))
        .then(() => console.log('routes: ' + JSON.stringify(routes)))
        .then(() => resolve(routes))
    })

    const followRoute = (routes) => {
      let path = routes[window.location.pathname]
      return new Promise((resolve, reject) => {
        if (typeof path === 'number') {
          let post = get(contents, path)
          buildQuery(post)
            .then(url => getQuery(url))
            .then(query => parseQuery(query))
            .then(result => resolve(result.post))
            .catch(err => reject(err))
        }
        else {
          resolve(path)
        }
      })
    }

    const buildSite = async () => {
      // build at first visit and cache routes
      buildQuery(queries.posts)
        .then(url => getQuery(url))
        .then(query => parseQuery(query))
        .then(result => buildRoutes(result))
        .then(async (routes) => {
          window.onpopstate = async () => {
            content.innerHTML = await followRoute(routes)
          }
          // let onNavItemClick = (pathName) => {
          //   window.history.pushState({}, pathName, window.location.origin + pathName)
          //   content.innerHTML = routes[pathName]
          // }
          content.innerHTML = await followRoute(routes)
        })
        .catch(err => reject(err))


    }

    buildSite()
  </script>
</body>

</html>